#!/bin/bash

source ./creds

# This is mostly for easy dev setup
# bc no docker-compose in windows. x.x
# (this is fixed now, will switch to compose soon.)

# Stop and remove any old containers
docker stop login  > /dev/null 2>/dev/null
docker stop game1  > /dev/null 2>/dev/null
docker stop game2  > /dev/null 2>/dev/null
docker stop game3  > /dev/null 2>/dev/null
docker stop mongo  > /dev/null 2>/dev/null
docker rm login  -f > /dev/null 2>/dev/null
docker rm game1  -f > /dev/null 2>/dev/null
docker rm game2  -f > /dev/null 2>/dev/null
docker rm game3  -f > /dev/null 2>/dev/null
docker rm mongo  -f > /dev/null 2>/dev/null

# Remove common code.

# serverclient is shared between client and game servers
# serverside is shared between login and game servers.

rm -rf ./game/app/app/_sharedClientSide
rm -rf ./login/app/app/js/_sharedClientSide
rm -rf ./game/app/_sharedServerSide
rm -rf ./login/app/_sharedServerSide
rm -rf ./login/app/app/public

mkdir ./game/app/app/_sharedClientSide  
mkdir ./login/app/app/js/_sharedClientSide  
mkdir ./game/app/_sharedServerSide  
mkdir ./login/app/_sharedServerSide  
mkdir ./login/app/app/public

cp -a ./common/sharedClientSide/. ./game/app/app/_sharedClientSide 
cp -a ./common/sharedClientSide/. ./login/app/app/js/_sharedClientSide 
cp -a ./common/sharedServerSide/. ./game/app/_sharedServerSide
cp -a ./common/sharedServerSide/. ./login/app/_sharedServerSide 
cp -a ./common/sharedClientSide/. ./login/app/app/public/

# build the various images.
set -e
docker build -t mongo ./mongodb/
docker build -t login ./login/
docker build -t game ./game/
set +e

# Run containers.
docker run --name mongo \
-p $MONGO_PORT:27017 \
-d mongo

docker run --name login \
-e SHARED_SERVER_SECRET=$SHARED_SERVER_SECRET \
-e SESSION_KEY=$SESSION_KEY \
-e GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID \
-e GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET \
-e GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL \
--link mongo:mongo \
-p $LOGIN_PORT:$LOGIN_PORT \
-d login

docker run \
-e SERVER_REGISTRATION_HOST=$SERVER_REGISTRATION_HOST \
-e SESSION_KEY=$SESSION_KEY \
-e SERVER_REGISTRATION_PORT=$LOGIN_PORT \
-e SHARED_SERVER_SECRET=$SHARED_SERVER_SECRET \
-e HOST=$GAME_HOSTNAME \
-e PORT=$GAME1_PORT \
-e GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID \
-e GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET \
-e GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL \
--name game1 \
-p $GAME1_PORT:3000 \
--link mongo:mongo \
-d game

docker run \
-e SERVER_REGISTRATION_HOST=$SERVER_REGISTRATION_HOST \
-e SESSION_KEY=$SESSION_KEY \
-e SERVER_REGISTRATION_PORT=$LOGIN_PORT \
-e SHARED_SERVER_SECRET=$SHARED_SERVER_SECRET \
-e HOST=$GAME_HOSTNAME \
-e PORT=$GAME2_PORT \
-e GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID \
-e GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET \
-e GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL \
--name game2 \
-p $GAME2_PORT:3000 \
--link mongo:mongo \
-d game

docker run \
-e SERVER_REGISTRATION_HOST=$SERVER_REGISTRATION_HOST \
-e SESSION_KEY=$SESSION_KEY \
-e SERVER_REGISTRATION_PORT=$LOGIN_PORT \
-e SHARED_SERVER_SECRET=$SHARED_SERVER_SECRET \
-e HOST=$GAME_HOSTNAME \
-e PORT=$GAME3_PORT \
-e GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID \
-e GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET \
-e GOOGLE_CALLBACK_URL=$GOOGLE_CALLBACK_URL \
--name game3 \
-p $GAME3_PORT:3000 \
--link mongo:mongo \
-d game